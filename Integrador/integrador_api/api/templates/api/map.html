<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Sistema de Monitoramento de Câmeras</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1a1a1a;
    color: #fff;
}

#map {
    height: 100vh;
    width: 100%;
}

/* Botão flutuante melhorado */
.floating-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.floating-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
}
.floating-btn-confirm{
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    width: 100px;
    height: 100px;
    fill: white;
    position: fixed;
    top: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
    border: none;
    /* border-radius: 50%; */
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.floating-btn svg {
    width: 24px;
    height: 24px;
    fill: white;
}

/* Menu overlay */
.menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    display: none;
    animation: fadeIn 0.3s ease;
}

.menu-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #3498db;
}

.menu-title {
    font-size: 24px;
    font-weight: bold;
    color: #3498db;
}

.close-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
    transition: color 0.3s ease;
}

.close-btn:hover {
    color: #e74c3c;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #ecf0f1;
}

.form-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #34495e;
    border-radius: 8px;
    background: #2c3e50;
    color: #fff;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-input:focus {
    outline: none;
    border-color: #3498db;
}

.form-row {
    display: flex;
    gap: 15px;
}

.form-row .form-group {
    flex: 1;
}

.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn-primary {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

.btn-secondary {
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    color: white;
    margin-right: 10px;
}

.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
}

/* Status panel */
.status-panel {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(44, 62, 80, 0.95);
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 1000;
    border-left: 4px solid #3498db;
}

.status-text {
    font-size: 14px;
    color: #ecf0f1;
}

.cameras-count {
    color: #3498db;
    font-weight: bold;
}

/* Loading spinner */
.loading-spinner {
    border: 3px solid #34495e;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Responsivo */
@media (max-width: 768px) {
    .menu-content {
        width: 95%;
        padding: 20px;
    }
    
    .form-row {
        flex-direction: column;
        gap: 0;
    }
    
    .floating-btn {
        width: 50px;
        height: 50px;
        top: 15px;
        right: 15px;
    }
    
    .status-panel {
        bottom: 15px;
        left: 15px;
        right: 15px;
    }
    button.status-panel{
        margin-left: 200;
    }
}
</style>
</head>
<body>

<!-- Botão flutuante -->
<button class="floating-btn" onclick="abrirMenu()">
    <svg viewBox="0 0 24 24">
        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
    </svg>
</button>

<!-- Menu overlay -->
<div class="menu-overlay" id="menuOverlay">
    <div class="menu-content">
        <div class="menu-header">
            <h2 class="menu-title">Adicionar Nova Câmera</h2>
            <button class="close-btn" onclick="fecharMenu()">&times;</button>
        </div>
        
        <form id="cameraForm">
            <div class="form-group">
                <label class="form-label">Nome da Câmera:</label>
                <input type="text" class="form-input" id="nome" required placeholder="Ex: Ponte da Amizade">
            </div>
            
            <div class="form-group">
                <label class="form-label">URL do Stream:</label>
                <input type="url" class="form-input" id="url_stream" required placeholder="https://...">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Latitude:</label>
                    <input type="number" class="form-input" id="latitude" step="any" required placeholder="-25.50949500">
                </div>
                <div class="form-group">
                    <label class="form-label">Longitude:</label>
                    <input type="number" class="form-input" id="longitude" step="any" required placeholder="-54.599215">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Direção (graus):</label>
                    <input type="number" class="form-input" id="direction" min="0" max="360" required placeholder="270">
                </div>
                <div class="form-group">
                    <label class="form-label">Alcance (metros):</label>
                    <input type="number" class="form-input" id="alcance" min="1" required placeholder="500">
                </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="adicionarPoint()">Adicionar Manualmente</button>
            
            <div style="text-align: right; margin-top: 25px;">
                <button type="button" class="btn btn-secondary" onclick="fecharMenu()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Adicionar Câmera</button>
            </div>
        </form>
    </div>
    
    
</div>
<button type="button" onclick="confirmPoint()" id="confirmButton" class="status-panel">Confirmar</button>

<!-- Status panel -->
<div class="status-panel">
    <div class="status-text">
        Câmeras ativas: <span class="cameras-count" id="camerasCount">0</span>
    </div>
</div>

<!-- Mapa -->
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Inicialização do mapa
var map = L.map('map').setView([-25.50949500, -54.599215], 10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

var markers = [];
var camerasAtivas = 0;

// Função para abrir o menu
function abrirMenu() {
    document.getElementById('menuOverlay').style.display = 'block';
}

// Função para fechar o menu
function fecharMenu() {
    document.getElementById('menuOverlay').style.display = 'none';
    document.getElementById('cameraForm').reset();
}

// Fechar menu clicando fora
document.getElementById('menuOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        fecharMenu();
    }
});

// Submit do formulário
document.getElementById('cameraForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        nome: document.getElementById('nome').value,
        url_stream: document.getElementById('url_stream').value,
        latitude: parseFloat(document.getElementById('latitude').value),
        longitude: parseFloat(document.getElementById('longitude').value),
        direction: parseInt(document.getElementById('direction').value),
        alcance: parseInt(document.getElementById('alcance').value)
    };
    
    adicionarCamera(formData);
});
function adicionarPoint(){
    document.getElementById('menuOverlay').style.display = 'none';
    document.getElementById('confirmButton').style.display = "block";
}
// Função para adicionar nova câmera
async function adicionarCamera(dados) {
    try {
        const response = await fetch('/cameras/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Câmera adicionada com sucesso!');
            fecharMenu();
            atualizarPontos(); // Atualiza o mapa
        } else {
            const error = await response.json();
            alert('Erro ao adicionar câmera: ' + error.message);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro de conexão ao adicionar câmera');
    }
}

// Função para atualizar pontos no mapa
function confirmPoint(){
    document.getElementById('menuOverlay').style.display = "block";
    document.getElementsById('confirmButton').style.display = "none";
}
async function atualizarPontos() {
    try {
        const response = await fetch('/points/');
        const data = await response.json();
        
        // Remove marcadores antigos
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        var latLngs = [];
        camerasAtivas = 0;
        
        data.forEach(ponto => {
            camerasAtivas++;
            
            // Marcador azul da câmera com popup
            var markerPonto = L.circleMarker([ponto.lat, ponto.lng], {
                radius: 8,
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.8,
                weight: 2
            }).addTo(map);
            
            markerPonto.bindPopup(`
                <b>${ponto.nome || 'Câmera'}</b><br>
                Coordenadas: ${ponto.lat.toFixed(6)}, ${ponto.lng.toFixed(6)}<br>
                Detecções: ${ponto.cars ? ponto.cars.length : 0}
            `);
            
            markers.push(markerPonto);
            latLngs.push([ponto.lat, ponto.lng]);
            
            // Adiciona os carros como pontos vermelhos
            if (ponto.cars && ponto.cars.length > 0) {
                ponto.cars.forEach((car, index) => {
                    var markerCar = L.circleMarker([car.lat, car.lng], {
                        radius: 5,
                        color: '#e74c3c',
                        fillColor: '#e74c3c',
                        fillOpacity: 0.8,
                        weight: 2
                    }).addTo(map);
                    
                    markerCar.bindPopup(`
                        <b>Detecção ${index + 1}</b><br>
                        Tipo: ${car.type || 'Veículo'}<br>
                        Confiança: ${car.confidence ? (car.confidence * 100).toFixed(1) + '%' : 'N/A'}
                    `);
                    
                    markers.push(markerCar);
                    latLngs.push([car.lat, car.lng]);
                });
            }
        });
        
        // Atualiza contador
        document.getElementById('camerasCount').textContent = camerasAtivas;
        
        // Ajusta o mapa para mostrar todos os pontos
        if (latLngs.length > 0) {
            map.fitBounds(L.latLngBounds(latLngs), { padding: [20, 20] });
        }
        
    } catch (error) {
        console.error('Erro ao atualizar pontos:', error);
        document.getElementById('camerasCount').textContent = 'Erro';
    }
}

// Inicialização
atualizarPontos();
setInterval(atualizarPontos, 30000); // Atualiza a cada 3 segundos

// Tecla ESC para fechar menu
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fecharMenu();
    }
});
</script>

</body>
</html>